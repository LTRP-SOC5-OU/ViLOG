# Migration `20201126061855`

This migration has been generated by Kohei Watanabe at 11/26/2020, 3:18:55 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "resources" (
"id" SERIAL,
    "video_id" INTEGER,
    "url" TEXT NOT NULL,
    "details" JSONB NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "videos" (
"id" SERIAL,
    "provider_url" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "tracks" (
"id" SERIAL,
    "video_id" INTEGER NOT NULL,
    "kind" TEXT NOT NULL DEFAULT E'subtitles',
    "language" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "topics" (
"id" SERIAL,
    "resource_id" INTEGER NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT NOT NULL,
    "time_required" INTEGER NOT NULL,
    "creator_id" INTEGER NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "details" JSONB NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "keywords" (
"id" SERIAL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "lti_context" (
    "id" TEXT NOT NULL,
    "title" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "lti_resource_link" (
    "id" TEXT NOT NULL,
    "context_id" TEXT NOT NULL,
    "title" TEXT NOT NULL,
    "book_id" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "books" (
"id" SERIAL,
    "name" TEXT NOT NULL,
    "abstract" TEXT NOT NULL,
    "author_id" INTEGER NOT NULL,
    "published_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "details" JSONB NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "sections" (
"id" SERIAL,
    "book_id" INTEGER NOT NULL,
    "order" INTEGER NOT NULL,
    "name" TEXT,

    PRIMARY KEY ("id")
)

CREATE TABLE "topic_sections" (
"id" SERIAL,
    "section_id" INTEGER NOT NULL,
    "topic_id" INTEGER NOT NULL,
    "order" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "users" (
"id" SERIAL,
    "lti_user_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "activities" (
"id" SERIAL,
    "topic_id" INTEGER NOT NULL,
    "learner_id" INTEGER NOT NULL,
    "type" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    PRIMARY KEY ("id")
)

CREATE TABLE "sessions" (
    "id" TEXT NOT NULL,
    "sid" TEXT NOT NULL,
    "data" TEXT NOT NULL,
    "expires" TIMESTAMP(3) NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "accounts" (
"id" SERIAL,
    "nonce" TEXT NOT NULL,
    "timestamp" INTEGER NOT NULL,

    PRIMARY KEY ("id")
)

CREATE TABLE "_KeywordToTopic" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL
)

CREATE TABLE "_BookToKeyword" (
    "A" INTEGER NOT NULL,
    "B" INTEGER NOT NULL
)

CREATE UNIQUE INDEX "resources.url_unique" ON "resources"("url")

CREATE UNIQUE INDEX "resources_video_id_unique" ON "resources"("video_id")

CREATE UNIQUE INDEX "keywords.name_unique" ON "keywords"("name")

CREATE INDEX "author_id" ON "books"("author_id")

CREATE INDEX "book_id" ON "sections"("book_id")

CREATE INDEX "section_id" ON "topic_sections"("section_id")

CREATE UNIQUE INDEX "users.lti_user_id_unique" ON "users"("lti_user_id")

CREATE INDEX "topic_id" ON "activities"("topic_id")

CREATE INDEX "learner_id" ON "activities"("learner_id")

CREATE UNIQUE INDEX "sessions.sid_unique" ON "sessions"("sid")

CREATE UNIQUE INDEX "accounts.nonce_timestamp_unique" ON "accounts"("nonce", "timestamp")

CREATE UNIQUE INDEX "_KeywordToTopic_AB_unique" ON "_KeywordToTopic"("A", "B")

CREATE INDEX "_KeywordToTopic_B_index" ON "_KeywordToTopic"("B")

CREATE UNIQUE INDEX "_BookToKeyword_AB_unique" ON "_BookToKeyword"("A", "B")

CREATE INDEX "_BookToKeyword_B_index" ON "_BookToKeyword"("B")

ALTER TABLE "resources" ADD FOREIGN KEY("video_id")REFERENCES "videos"("id") ON DELETE SET NULL ON UPDATE CASCADE

ALTER TABLE "tracks" ADD FOREIGN KEY("video_id")REFERENCES "videos"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "topics" ADD FOREIGN KEY("resource_id")REFERENCES "resources"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "topics" ADD FOREIGN KEY("creator_id")REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "lti_resource_link" ADD FOREIGN KEY("context_id")REFERENCES "lti_context"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "lti_resource_link" ADD FOREIGN KEY("book_id")REFERENCES "books"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "books" ADD FOREIGN KEY("author_id")REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "sections" ADD FOREIGN KEY("book_id")REFERENCES "books"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "topic_sections" ADD FOREIGN KEY("section_id")REFERENCES "sections"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "topic_sections" ADD FOREIGN KEY("topic_id")REFERENCES "topics"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "activities" ADD FOREIGN KEY("topic_id")REFERENCES "topics"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "activities" ADD FOREIGN KEY("learner_id")REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_KeywordToTopic" ADD FOREIGN KEY("A")REFERENCES "keywords"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_KeywordToTopic" ADD FOREIGN KEY("B")REFERENCES "topics"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_BookToKeyword" ADD FOREIGN KEY("A")REFERENCES "books"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "_BookToKeyword" ADD FOREIGN KEY("B")REFERENCES "keywords"("id") ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20201126061855
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,227 @@
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+generator client {
+  provider = "prisma-client-js"
+}
+
+generator jsonSchema {
+  provider = "prisma-json-schema-generator"
+  output   = "."
+}
+
+// Resource Objects
+
+/// 教育用外部リソース
+model Resource {
+  id      Int     @id @default(autoincrement())
+  topics  Topic[]
+  video   Video?  @relation(fields: [videoId], references: [id])
+  videoId Int?    @map(name: "video_id")
+  /// 外部リソースのアドレス
+  url     String  @unique
+  /// 詳細
+  details Json
+
+  @@map(name: "resources")
+}
+
+/// ビデオ
+model Video {
+  id          Int      @id @default(autoincrement())
+  resource    Resource?
+  tracks      Track[]
+  /// 動画プロバイダーの識別子: "https://www.youtube.com/" | "https://vimeo.com/"
+  providerUrl String?  @map(name: "provider_url")
+
+  @@map(name: "videos")
+}
+
+/// ビデオのトラック (字幕・キャプション)
+model Track {
+  id       Int    @id @default(autoincrement())
+  video    Video  @relation(fields: [videoId], references: [id])
+  videoId  Int    @map(name: "video_id")
+  /// 種別 "subtitles": 字幕
+  kind     String @default("subtitles")
+  /// 言語 ISO 639-1 code
+  language String
+
+  @@map(name: "tracks")
+}
+
+// Topic Objects
+
+/// トピック
+model Topic {
+  id           Int            @id @default(autoincrement())
+  resource     Resource       @relation(fields: [resourceId], references: [id])
+  resourceId   Int            @map(name: "resource_id")
+  keywords     Keyword[]      @relation(references: [id])
+  topicSection TopicSection[]
+  activities   Activity[]
+  /// トピック名称
+  name         String
+  /// 説明
+  description  String
+  /// 学習所要時間 (秒)
+  timeRequired Int            @map(name: "time_required")
+  /// 作成者
+  creator      User           @relation(fields: [creatorId], references: [id])
+  creatorId    Int            @map(name: "creator_id")
+  /// 作成日
+  createdAt    DateTime       @default(now()) @map(name: "created_at")
+  /// 更新日
+  updatedAt    DateTime       @default(now()) @map(name: "updated_at")
+  /// 詳細
+  details      Json
+
+  @@map(name: "topics")
+}
+
+/// キーワード
+model Keyword {
+  id     Int     @id @default(autoincrement())
+  topics Topic[] @relation(references: [id])
+  books  Book[]  @relation(references: [id])
+  /// 名称 (カンマ "," を含めない)
+  name   String  @unique
+
+  @@map(name: "keywords")
+}
+
+// Map Objects/Learning Contents
+
+/// LTI Context
+model LtiContext {
+  id            String            @id
+  resourceLinks LtiResourceLink[]
+  title         String
+
+  @@map(name: "lti_context")
+}
+
+/// LTI ResourceLink
+model LtiResourceLink {
+  id        String     @id
+  context   LtiContext @relation(fields: [contextId], references: [id])
+  contextId String     @map(name: "context_id")
+  title     String
+  book      Book       @relation(fields: [bookId], references: [id])
+  bookId    Int        @map(name: "book_id")
+
+  @@map(name: "lti_resource_link")
+}
+
+/// ブック
+model Book {
+  id               Int               @id @default(autoincrement())
+  keywords         Keyword[]         @relation(references: [id])
+  sections         Section[]
+  ltiResourceLinks LtiResourceLink[]
+  /// 題名
+  name             String
+  /// 概要
+  abstract         String
+  /// 著作者
+  author           User              @relation(fields: [authorId], references: [id])
+  authorId         Int               @map(name: "author_id")
+  /// 公開日
+  publishedAt      DateTime          @default(now()) @map(name: "published_at")
+  /// 作成日
+  createdAt        DateTime          @default(now()) @map(name: "created_at")
+  /// 更新日
+  updatedAt        DateTime          @default(now()) @map(name: "updated_at")
+  /// 詳細
+  details          Json
+
+  @@index([authorId], name: "author_id")
+  @@map(name: "books")
+}
+
+/// セクション
+model Section {
+  id            Int            @id @default(autoincrement())
+  book          Book           @relation(fields: [bookId], references: [id])
+  bookId        Int            @map(name: "book_id")
+  topicSections TopicSection[]
+  /// 順番 (昇順)
+  order         Int
+  /// 名称 (nullならば匿名のトピックの集まり)
+  name          String?
+
+  @@index([bookId], name: "book_id")
+  @@map(name: "sections")
+}
+
+/// セクション内トピック
+model TopicSection {
+  id        Int     @id @default(autoincrement())
+  section   Section @relation(fields: [sectionId], references: [id])
+  sectionId Int     @map(name: "section_id")
+  topic     Topic   @relation(fields: [topicId], references: [id])
+  topicId   Int     @map(name: "topic_id")
+  /// 順番 (昇順)
+  order     Int
+
+  @@index([sectionId], name: "section_id")
+  @@map(name: "topic_sections")
+}
+
+// Actors
+
+/// 利用者
+model User {
+  id            Int        @id @default(autoincrement())
+  createdTopics Topic[]
+  writtenBooks  Book[]
+  ltiUserId     String     @unique @map(name: "lti_user_id")
+  activities    Activity[]
+  /// 氏名
+  name          String
+
+  @@map(name: "users")
+}
+
+/// 学習活動
+model Activity {
+  id        Int      @id @default(autoincrement())
+  topic     Topic    @relation(fields: [topicId], references: [id])
+  topicId   Int      @map(name: "topic_id")
+  learner   User     @relation(fields: [learnerId], references: [id])
+  learnerId Int      @map(name: "learner_id")
+  /// 学習活動種別: "viewed" | "completed"
+  type      String
+  /// 作成日
+  createdAt DateTime @default(now()) @map(name: "created_at")
+  /// 更新日
+  updatedAt DateTime @default(now()) @map(name: "updated_at")
+
+  @@index([topicId], name: "topic_id")
+  @@index([learnerId], name: "learner_id")
+  @@map(name: "activities")
+}
+
+// Etc.
+
+/// セッションストア
+model Session {
+  id      String   @id
+  sid     String   @unique @default(cuid())
+  data    String
+  expires DateTime
+
+  @@map(name: "sessions")
+}
+
+/// OAuth Account
+model Account {
+  id        Int    @id @default(autoincrement())
+  nonce     String
+  timestamp Int
+
+  @@unique([nonce, timestamp])
+  @@map(name: "accounts")
+}
```


